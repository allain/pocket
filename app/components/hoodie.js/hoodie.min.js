// Generated by CoffeeScript 1.3.3
var Events,Hoodie,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__bind=function(e,t){return function(){return e.apply(t,arguments)}};Events=function(){function e(){}return e.prototype.bind=function(e,t){var n,r,i,s,o,u;r=e.split(" "),n=this.hasOwnProperty("_callbacks")&&this._callbacks||(this._callbacks={}),u=[];for(s=0,o=r.length;s<o;s++)i=r[s],n[i]||(n[i]=[]),u.push(n[i].push(t));return u},e.prototype.on=e.prototype.bind,e.prototype.one=function(e,t){return this.bind(e,function(){return this.unbind(e,arguments.callee),t.apply(this,arguments)})},e.prototype.trigger=function(){var e,t,n,r,i,s,o;e=1<=arguments.length?__slice.call(arguments,0):[],n=e.shift(),r=this.hasOwnProperty("_callbacks")&&((o=this._callbacks)!=null?o[n]:void 0);if(!r)return;for(i=0,s=r.length;i<s;i++)t=r[i],t.apply(this,e);return!0},e.prototype.unbind=function(e,t){var n,r,i,s,o,u;if(!e)return this._callbacks={},this;i=(u=this._callbacks)!=null?u[e]:void 0;if(!i)return this;if(!t)return delete this._callbacks[e],this;for(r=s=0,o=i.length;s<o;r=++s){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this._callbacks[e]=i;break}return this},e}(),Hoodie=function(e){function t(e){this.baseUrl=e,this.baseUrl?this.baseUrl=this.baseUrl.replace(/\/+$/,""):this.baseUrl=location.protocol+"//api."+location.hostname.replace(/^www\./,""),this.store=new this.constructor.LocalStore(this),this.config=new this.constructor.Config(this),this.account=new this.constructor.Account(this),this.remote=new this.constructor.AccountRemote(this),this._loadExtensions()}return __extends(t,e),t.prototype.request=function(e,t,n){var r;return n==null&&(n={}),r={type:e,url:""+this.baseUrl+t,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},$.ajax($.extend(r,n))},t.prototype.open=function(e,n){return n==null&&(n={}),$.extend(n,{name:e}),new t.Remote(this,n)},t.prototype.uuid=function(e){var t,n,r;return e==null&&(e=7),t="0123456789abcdefghijklmnopqrstuvwxyz".split(""),r=t.length,function(){var s,o;o=[];for(n=s=0;0<=e?s<e:s>e;n=0<=e?++s:--s)o.push(t[0|Math.random()*r]);return o}().join("")},t.prototype.defer=$.Deferred,t.prototype.isPromise=function(e){return typeof (e!=null?e.done:void 0)=="function"&&typeof e.resolve=="undefined"},t.prototype.resolveWith=function(){var e;return(e=this.defer()).resolve.apply(e,arguments).promise()},t.prototype.rejectWith=function(){var e;return(e=this.defer()).reject.apply(e,arguments).promise()},t.extend=function(e,t){return this._extensions||(this._extensions={}),this._extensions[e]=t},t.prototype.extend=function(e,t){return this[e]=new t(this)},t.prototype._loadExtensions=function(){var e,t,n,r;n=this.constructor._extensions,r=[];for(t in n)e=n[t],r.push(this[t]=new e(this));return r},t}(Events),Hoodie.Account=function(){function e(e){this.hoodie=e,this._handleChangeUsernameAndPasswordRequest=__bind(this._handleChangeUsernameAndPasswordRequest,this),this._sendChangeUsernameAndPasswordRequest=__bind(this._sendChangeUsernameAndPasswordRequest,this),this._cleanup=__bind(this._cleanup,this),this._handleFetchBeforeDestroySucces=__bind(this._handleFetchBeforeDestroySucces,this),this._handlePasswordResetStatusRequestError=__bind(this._handlePasswordResetStatusRequestError,this),this._handlePasswordResetStatusRequestSuccess=__bind(this._handlePasswordResetStatusRequestSuccess,this),this._checkPasswordResetStatus=__bind(this._checkPasswordResetStatus,this),this._handleSignInSuccess=__bind(this._handleSignInSuccess,this),this._delayedSignIn=__bind(this._delayedSignIn,this),this._handleSignUpSucces=__bind(this._handleSignUpSucces,this),this._handleRequestError=__bind(this._handleRequestError,this),this._handleAuthenticateSuccess=__bind(this._handleAuthenticateSuccess,this),this.fetch=__bind(this.fetch,this),this.authenticate=__bind(this.authenticate,this),this.username=this.hoodie.config.get("_account.username"),this.ownerHash=this.hoodie.config.get("_account.ownerHash"),this.ownerHash||this._setOwner(this.hoodie.uuid()),window.setTimeout(this.authenticate),this._checkPasswordResetStatus()}return e.prototype.username=void 0,e.prototype.authenticate=function(){return this.username?this._authenticated===!0?this.hoodie.defer().resolve(this.username).promise():this._authenticated===!1?this.hoodie.defer().reject().promise():this.hoodie.request("GET","/_session").pipe(this._handleAuthenticateSuccess,this._handleRequestError):(this._sendSignOutRequest(),this.hoodie.defer().reject().promise())},e.prototype.signUp=function(e,t){var n;return t==null&&(t=""),e?this.hasAnonymousAccount()?this._upgradeAnonymousAccount(e,t):this.hasAccount()?this.hoodie.defer().reject({error:"you have to sign out first"}).promise():(n={data:JSON.stringify({_id:this._key(e),name:this._userKey(e),type:"user",roles:[],password:t,ownerHash:this.ownerHash,database:this.db()}),contentType:"application/json"},this.hoodie.request("PUT",this._url(e),n).pipe(this._handleSignUpSucces(e,t),this._handleRequestError)):this.hoodie.defer().reject({error:"username must be set"}).promise()},e.prototype.anonymousSignUp=function(){var e,t,n=this;return e=this.hoodie.uuid(10),t=this.ownerHash,this.signUp(t,e).pipe(null,this._handleRequestError).done(function(){return n.hoodie.config.set("_account.anonymousPassword",e),n.trigger("signup:anonymous",t)})},e.prototype.hasAccount=function(){return this.username!=null},e.prototype.hasAnonymousAccount=function(){return this.hoodie.config.get("_account.anonymousPassword")!=null},e.prototype.signIn=function(e,t){var n=this;return t==null&&(t=""),this.signOut().pipe(function(){return n._sendSignInRequest(e,t)})},e.prototype.signOut=function(){return this.hasAccount()?(this.hoodie.remote.disconnect(),this._sendSignOutRequest().pipe(this._cleanup)):this._cleanup()},e.prototype.on=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1account:$2"),this.hoodie.on(e,t)},e.prototype.trigger=function(){var e,t,n;return e=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],(n=this.hoodie).trigger.apply(n,["account:"+e].concat(__slice.call(t)))},e.prototype.db=function(){return"user/"+this.ownerHash},e.prototype.fetch=function(e){var t=this;return e==null&&(e=this.username),e?this._withSingleRequest("fetch",function(){return t.hoodie.request("GET",t._url(e)).pipe(null,t._handleRequestError).done(function(e){return t._doc=e})}):this.hoodie.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},e.prototype.changePassword=function(e,t){return this.username?(this.hoodie.remote.disconnect(),this.fetch().pipe(this._sendChangeUsernameAndPasswordRequest(e,null,t),this._handleRequestError)):this.hoodie.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},e.prototype.resetPassword=function(e){var t,n,r,i,s=this;return(i=this.hoodie.config.get("_account.resetPasswordId"))?this._checkPasswordResetStatus():(i=""+e+"/"+this.hoodie.uuid(),this.hoodie.config.set("_account.resetPasswordId",i),n=""+this._prefix+":$passwordReset/"+i,t={_id:n,name:"$passwordReset/"+i,type:"user",roles:[],password:i,$createdAt:new Date,$updatedAt:new Date},r={data:JSON.stringify(t),contentType:"application/json"},this._withPreviousRequestsAborted("resetPassword",function(){return s.hoodie.request("PUT","/_users/"+encodeURIComponent(n),r).pipe(null,s._handleRequestError).done(s._checkPasswordResetStatus)}))},e.prototype.changeUsername=function(e,t){return this._changeUsernameAndPassword(e,t)},e.prototype.destroy=function(){return this.hasAccount()?this.fetch().pipe(this._handleFetchBeforeDestroySucces,this._handleRequestError).pipe(this._cleanup):this._cleanup()},e.prototype._prefix="org.couchdb.user",e.prototype._doc={},e.prototype._requests={},e.prototype._setUsername=function(e){return this.username=e,this.hoodie.config.set("_account.username",this.username)},e.prototype._setOwner=function(e){return this.ownerHash=e,this.hoodie.config.set("$createdBy",this.ownerHash),this.hoodie.config.set("_account.ownerHash",this.ownerHash)},e.prototype._handleAuthenticateSuccess=function(e){var t;return t=this.hoodie.defer(),e.userCtx.name?(this._authenticated=!0,this._setUsername(e.userCtx.name.replace(/^user(_anonymous)?\//,"")),this._setOwner(e.userCtx.roles[0]),t.resolve(this.username)):(this._authenticated=!1,this.trigger("error:unauthenticated"),t.reject()),t.promise()},e.prototype._handleRequestError=function(e){var t;e==null&&(e={});try{t=JSON.parse(e.responseText)}catch(n){t={error:e.responseText||"unknown"}}return this.hoodie.defer().reject(t).promise()},e.prototype._handleSignUpSucces=function(e,t){var n,r=this;return n=this.hoodie.defer(),function(n){return r.trigger("signup",e),r._doc._rev=n.rev,r._delayedSignIn(e,t)}},e.prototype._delayedSignIn=function(e,t){var n,r=this;return n=this.hoodie.defer(),window.setTimeout(function(){var i;return i=r._sendSignInRequest(e,t),i.done(n.resolve),i.fail(function(i){return i.error==="unconfirmed"?r._delayedSignIn(e,t):n.reject.apply(n,arguments)})},300),n.promise()},e.prototype._handleSignInSuccess=function(e){var t,n,r=this;return t=this.hoodie.defer(),n=e.name.replace(/^user(_anonymous)?\//,""),~e.roles.indexOf("error")?(this.fetch(n).fail(t.reject).done(function(){return t.reject({error:"error",reason:r._doc.$error})}),t.promise()):~e.roles.indexOf("confirmed")?(this._authenticated=!0,this._setOwner(e.roles[0]),this._setUsername(n),this.hasAnonymousAccount()?this.trigger("signin:anonymous",n):this.trigger("signin",n),this.fetch(),t.resolve(this.username,e.roles[0])):t.reject({error:"unconfirmed",reason:"account has not been confirmed yet"})},e.prototype._checkPasswordResetStatus=function(){var e,t,n,r,i,s=this;return n=this.hoodie.config.get("_account.resetPasswordId"),n?(i="$passwordReset/"+n,r="/_users/"+encodeURIComponent(""+this._prefix+":"+i),e=btoa(""+i+":"+n),t={headers:{Authorization:"Basic "+e}},this._withPreviousRequestsAborted("passwordResetStatus",function(){return s.hoodie.request("GET",r,t).pipe(s._handlePasswordResetStatusRequestSuccess,s._handlePasswordResetStatusRequestError).fail(function(e){if(e.error==="pending"){window.setTimeout(s._checkPasswordResetStatus,1e3);return}return s.trigger("password_reset:error")})})):this.hoodie.defer().reject({error:"missing"}).promise()},e.prototype._handlePasswordResetStatusRequestSuccess=function(e){var t;return t=this.hoodie.defer(),e.$error?t.reject(e.$error):t.reject({error:"pending"}),t.promise()},e.prototype._handlePasswordResetStatusRequestError=function(e){return e.status===401?(this.hoodie.config.remove("_account.resetPasswordId"),this.trigger("passwordreset"),this.hoodie.defer().resolve()):this._handleRequestError(e)},e.prototype._changeUsernameAndPassword=function(e,t,n){var r=this;return this._sendSignInRequest(this.username,e).pipe(function(){return r.fetch().pipe(r._sendChangeUsernameAndPasswordRequest(e,t,n))})},e.prototype._upgradeAnonymousAccount=function(e,t){var n,r=this;return n=this.hoodie.config.get("_account.anonymousPassword"),this._changeUsernameAndPassword(n,e,t).done(function(){return r.trigger("signup",e),r.hoodie.config.remove("_account.anonymousPassword")})},e.prototype._handleFetchBeforeDestroySucces=function(){var e=this;return this.hoodie.remote.disconnect(),this._doc._deleted=!0,this._withPreviousRequestsAborted("updateUsersDoc",function(){return e.hoodie.request("PUT",e._url(),{data:JSON.stringify(e._doc),contentType:"application/json"})})},e.prototype._cleanup=function(){return delete this.username,delete this._authenticated,this.hoodie.config.clear(),this.trigger("signout"),this._setOwner(this.hoodie.uuid()),this.hoodie.defer().resolve().promise()},e.prototype._userKey=function(e){return e===this.ownerHash?"user_anonymous/"+e:"user/"+e},e.prototype._key=function(e){return e==null&&(e=this.username),""+this._prefix+":"+this._userKey(e)},e.prototype._url=function(e){return"/_users/"+encodeURIComponent(this._key(e))},e.prototype._sendChangeUsernameAndPasswordRequest=function(e,t,n){var r=this;return function(){var i,s;return i=$.extend({},r._doc),t&&(i.$newUsername=t),n!=null&&(delete i.salt,delete i.password_sha,i.password=n),s={data:JSON.stringify(i),contentType:"application/json"},r._withPreviousRequestsAborted("updateUsersDoc",function(){return r.hoodie.request("PUT",r._url(),s).pipe(r._handleChangeUsernameAndPasswordRequest(t,n||e),r._handleRequestError)})}},e.prototype._handleChangeUsernameAndPasswordRequest=function(e,t){var n=this;return function(){return n.hoodie.remote.disconnect(),e?n._delayedSignIn(e,t):n.signIn(n.username,t)}},e.prototype._withPreviousRequestsAborted=function(e,t){var n;return(n=this._requests[e])!=null&&typeof n.abort=="function"&&n.abort(),this._requests[e]=t()},e.prototype._withSingleRequest=function(e,t){var n;return((n=this._requests[e])!=null?typeof n.state=="function"?n.state():void 0:void 0)==="pending"?this._requests[e]:this._requests[e]=t()},e.prototype._sendSignOutRequest=function(){var e=this;return this._withSingleRequest("signOut",function(){return e.hoodie.request("DELETE","/_session").pipe(null,e._handleRequestError)})},e.prototype._sendSignInRequest=function(e,t){var n,r=this;return n={data:{name:this._userKey(e),password:t}},this._withPreviousRequestsAborted("signIn",function(){var e;return e=r.hoodie.request("POST","/_session",n),e.pipe(r._handleSignInSuccess,r._handleRequestError)})},e}(),Hoodie.Config=function(){function e(e,t){var n=this;this.hoodie=e,t==null&&(t={}),this.clear=__bind(this.clear,this),t.$type&&(this.$type=t.$type),t.id&&(this.id=t.id),this.hoodie.store.find(this.$type,this.id).done(function(e){return n.cache=e}),this.hoodie.on("account:signedOut",this.clear)}return e.prototype.$type="$config",e.prototype.id="hoodie",e.prototype.cache={},e.prototype.set=function(e,t){var n,r;if(this.cache[e]===t)return;return this.cache[e]=t,r={},r[e]=t,n=e.charAt(0)==="_",this.hoodie.store.update(this.$type,this.id,r,{silent:n})},e.prototype.get=function(e){return this.cache[e]},e.prototype.clear=function(){return this.cache={},this.hoodie.store.remove(this.$type,this.id)},e.prototype.remove=e.prototype.set,e}(),Hoodie.Email=function(){function e(e){this.hoodie=e,this._handleEmailUpdate=__bind(this._handleEmailUpdate,this)}return e.prototype.send=function(e){var t,n,r=this;return e==null&&(e={}),n=this.hoodie.defer(),t=$.extend({},e),this._isValidEmail(e.to)?(this.hoodie.store.add("$email",t).then(function(e){return r._handleEmailUpdate(n,e)}),n.promise()):(t.error="Invalid email address ("+(t.to||"empty")+")",n.reject(t).promise())},e.prototype._isValidEmail=function(e){return e==null&&(e=""),/@/.test(e)},e.prototype._handleEmailUpdate=function(e,t){var n=this;return t==null&&(t={}),t.error?e.reject(t):t.deliveredAt?e.resolve(t):this.hoodie.remote.one("updated:$email:"+t.id,function(t){return n._handleEmailUpdate(e,t)})},e}(),Hoodie.extend("email",Hoodie.Email),Hoodie.Errors={INVALID_KEY:function(e){var t;return t=e.id?"id":"type",new Error("invalid "+t+" '"+e[t]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(e){return new Error(e)},NOT_FOUND:function(e,t){return new Error(""+e+" with "+t+" could not be found")}},Hoodie.Remote=function(){function e(e,t){this.hoodie=e,t==null&&(t={}),this._handlePushSuccess=__bind(this._handlePushSuccess,this),this._handlePullResults=__bind(this._handlePullResults,this),this._handlePullError=__bind(this._handlePullError,this),this._handlePullSuccess=__bind(this._handlePullSuccess,this),this._restartPullRequest=__bind(this._restartPullRequest,this),this.sync=__bind(this.sync,this),this.push=__bind(this.push,this),this.pull=__bind(this.pull,this),this.stopSyncing=__bind(this.stopSyncing,this),this.startSyncing=__bind(this.startSyncing,this),this.disconnect=__bind(this.disconnect,this),this.connect=__bind(this.connect,this),t.name!=null&&(this.name=t.name,this.prefix=this.name),t.prefix!=null&&(this.prefix=t.prefix),t.sync&&(this._sync=t.sync),this.store=new Hoodie.RemoteStore(this.hoodie,this),this.isContinuouslySyncing()&&this.startSyncing()}return e.prototype.name=void 0,e.prototype._sync=!1,e.prototype.prefix="",e.prototype.request=function(e,t,n){n==null&&(n={}),this.name&&(t="/"+encodeURIComponent(this.name)+t),n.contentType||(n.contentType="application/json");if(e==="POST"||e==="PUT")n.dataType||(n.dataType="json"),n.processData||(n.processData=!1),n.data=JSON.stringify(n.data);return this.hoodie.request(e,t,n)},e.prototype.get=function(e,t){return console.log.apply(console,[".get() not yet implemented"].concat(__slice.call(arguments)))},e.prototype.post=function(e,t){return console.log.apply(console,[".post() not yet implemented"].concat(__slice.call(arguments)))},e.prototype.connect=function(e){return this.connected=!0,this.sync()},e.prototype.disconnect=function(){var e,t;return this.connected=!1,(e=this._pullRequest)!=null&&e.abort(),(t=this._pushRequest)!=null?t.abort():void 0},e.prototype.startSyncing=function(){return this._sync=!0,this.connect()},e.prototype.stopSyncing=function(){return this._sync=!1},e.prototype.isContinuouslyPulling=function(){var e;return this._sync===!0||((e=this._sync)!=null?e.pull:void 0)===!0},e.prototype.isContinuouslyPushing=function(){var e;return this._sync===!0||((e=this._sync)!=null?e.push:void 0)===!0},e.prototype.isContinuouslySyncing=function(){return this._sync===!0},e.prototype.getSinceNr=function(){return this._since||0},e.prototype.setSinceNr=function(e){return this._since=e},e.prototype.pull=function(){return this._pullRequest=this.request("GET",this._pullUrl()),this.connected&&this.isContinuouslyPulling()&&(window.clearTimeout(this._pullRequestTimeout),this._pullRequestTimeout=window.setTimeout(this._restartPullRequest,25e3)),this._pullRequest.then(this._handlePullSuccess,this._handlePullError)},e.prototype.push=function(e){var t,n,r,i;if(e!=null?!e.length:!void 0)return this.hoodie.defer().resolve([]).promise();n=[];for(r=0,i=e.length;r<i;r++)t=e[r],n.push(this.store.parseForRemote(t));return this._pushRequest=this.request("POST","/_bulk_docs",{data:{docs:n,new_edits:!1}}),this._pushRequest.done(this._handlePushSuccess(e,n))},e.prototype.sync=function(e){return this.push(e).pipe(this.pull)},e.prototype.on=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.on(e,t)},e.prototype.one=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.one(e,t)},e.prototype.trigger=function(){var e,t,n;return e=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],(n=this.hoodie).trigger.apply(n,[""+this.name+":"+e].concat(__slice.call(t)))},e.prototype._pullUrl=function(){var e;return e=this.getSinceNr(),this.isContinuouslyPulling()?"/_changes?include_docs=true&since="+e+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+e},e.prototype._restartPullRequest=function(){var e;return(e=this._pullRequest)!=null?e.abort():void 0},e.prototype._handlePullSuccess=function(e){this.setSinceNr(e.last_seq),this._handlePullResults(e.results);if(this.connected&&this.isContinuouslyPulling())return this.pull()},e.prototype._handlePullError=function(e,t,n){if(!this.connected)return;switch(e.status){case 401:return this.trigger("error:unauthenticated",t),this.disconnect();case 404:return window.setTimeout(this.pull,3e3);case 500:return this.trigger("error:server",t),window.setTimeout(this.pull,3e3);default:if(!this.isContinuouslyPulling())return;return e.statusText==="abort"?this.pull():window.setTimeout(this.pull,3e3)}},e.prototype._knownObjects={},e.prototype._handlePullResults=function(e){var t,n,r,i,s,o;o=[];for(i=0,s=e.length;i<s;i++)t=e[i].doc,r=this.store.parseFromRemote(t),r._deleted?(n="remove",delete this._knownObjects[t._id]):this._knownObjects[t._id]?n="update":(n="add",this._knownObjects[t._id]=1),this.trigger("store:"+n,r),this.trigger("store:"+n+":"+r.$type,r),this.trigger("store:"+n+":"+r.$type+":"+r.id,r),this.trigger("store:change",n,r),this.trigger("store:change:"+r.$type,n,r),o.push(this.trigger("store:change:"+r.$type+":"+r.id,n,r));return o},e.prototype._handlePushSuccess=function(e,t){},e}(),Hoodie.Share=function(){function e(e){var t;return this.hoodie=e,this._open=__bind(this._open,this),this.instance=Hoodie.ShareInstance,t=this._open,$.extend(t,this),this.hoodie.store.decoratePromises({shareAt:this._storeShareAt,unshareAt:this._storeUnshareAt,unshare:this._storeUnshare,share:this._storeShare}),t}return e.prototype.add=function(e){var t=this;return e==null&&(e={}),this.hoodie.store.add("$share",this._filterShareOptions(e)).pipe(function(e){return t.hoodie.account.hasAccount()||t.hoodie.account.anonymousSignUp(),new t.instance(t.hoodie,e)})},e.prototype.find=function(e){var t=this;return this.hoodie.store.find("$share",e).pipe(function(e){return new t.instance(t.hoodie,e)})},e.prototype.findAll=function(){var e=this;return this.hoodie.store.findAll("$share").pipe(function(t){var n,r,i,s;s=[];for(r=0,i=t.length;r<i;r++)n=t[r],s.push(new e.instance(e.hoodie,n));return s})},e.prototype.findOrAdd=function(e,t){var n=this;return this.hoodie.store.findOrAdd("$share",e,this._filterShareOptions(t)).pipe(function(e){return n.hoodie.account.hasAccount()||n.hoodie.account.anonymousSignUp(),new n.instance(n.hoodie,e)})},e.prototype.save=function(e,t){var n=this;return this.hoodie.store.save("$share",e,this._filterShareOptions(t)).pipe(function(e){return new n.instance(n.hoodie,e)})},e.prototype.update=function(e,t){var n=this;return this.hoodie.store.update("$share",e,this._filterShareOptions(t)).pipe(function(e){return new n.instance(n.hoodie,e)})},e.prototype.updateAll=function(e){var t=this;return this.hoodie.store.updateAll("$share",this._filterShareOptions(e)).pipe(function(e){var n,r,i,s;s=[];for(r=0,i=e.length;r<i;r++)n=e[r],s.push(new t.instance(t.hoodie,n));return s})},e.prototype.remove=function(e){return this.hoodie.store.findAll(function(t){return t.$shares[e]}).unshareAt(e),this.hoodie.store.remove("$share",e)},e.prototype.removeAll=function(){return this.hoodie.store.findAll(function(e){return e.$shares}).unshare(),this.hoodie.store.removeAll("$share")},e.prototype._allowedOptions=["id","access","$createdBy"],e.prototype._filterShareOptions=function(e){var t,n,r,i,s;e==null&&(e={}),t={},s=this._allowedOptions;for(r=0,i=s.length;r<i;r++)n=s[r],e.hasOwnProperty(n)&&(t[n]=e[n]);return t},e.prototype._open=function(e,t){return t==null&&(t={}),$.extend(t,{id:e}),new this.instance(this.hoodie,t)},e.prototype._storeShareAt=function(e,t){var n=this;return this.pipe(function(r){var i,s,o,u,a;s=function(r){return r.$shares||(r.$shares={}),r.$shares[e]=t||!0,n.hoodie.store.update(r.$type,r.id,{$shares:r.$shares}),r};if($.isArray(r)){a=[];for(o=0,u=r.length;o<u;o++)i=r[o],a.push(s(i));return a}return s(r)})},e.prototype._storeUnshareAt=function(e){var t=this;return this.pipe(function(n){var r,i,s,o,u;i=function(n){return!n.$shares||!n.$shares[e]?n:(n.$shares[e]=!1,t.hoodie.store.update(n.$type,n.id,{$shares:n.$shares}),n)};if($.isArray(n)){u=[];for(s=0,o=n.length;s<o;s++)r=n[s],u.push(i(r));return u}return i(n)})},e.prototype._storeUnshare=function(){var e=this;return this.pipe(function(t){var n,r,i,s,o;r=function(t){var n;if(!t.$shares)return t;for(n in t.$shares)t.$shares[n]=!1;return e.hoodie.store.update(t.$type,t.id,{$shares:t.$shares}),t};if($.isArray(t)){o=[];for(i=0,s=t.length;i<s;i++)n=t[i],o.push(r(n));return o}return r(t)})},e.prototype._storeShare=function(e){var t=this;return this.pipe(function(n){return t.hoodie.share.add().pipe(function(r){var i,s,o;return s=function(n){return n.$shares||(n.$shares={}),n.$shares[r.id]=e||!0,t.hoodie.store.update(n.$type,n.id,{$shares:n.$shares}),n},o=function(){var e,t,r;if($.isArray(n)){r=[];for(e=0,t=n.length;e<t;e++)i=n[e],r.push(s(i));return r}return s(n)}(),t.hoodie.defer().resolve(o,r).promise()})})},e}(),Hoodie.extend("share",Hoodie.Share),Hoodie.Store=function(){function e(e){this.hoodie=e}return e.prototype.save=function(e,t,n,r){var i;return r==null&&(r={}),i=this.hoodie.defer(),typeof n!="object"?(i.reject(Hoodie.Errors.INVALID_ARGUMENTS("object is "+typeof n)),i.promise()):t&&!this._isValidId(t)?i.reject(Hoodie.Errors.INVALID_KEY({id:t})).promise():this._isValidType(e)?i:i.reject(Hoodie.Errors.INVALID_KEY({type:e})).promise()},e.prototype.add=function(e,t,n){return t==null&&(t={}),n==null&&(n={}),this.save(e,t.id,t)},e.prototype.update=function(e,t,n,r){var i,s,o=this;return i=this.hoodie.defer(),s=this.find(e,t).pipe(function(s){var u,a,f;return typeof n=="function"&&(n=n($.extend({},s))),n?(u=function(){var e;e=[];for(a in n){f=n[a];if(s[a]===f)continue;s[a]=f,e.push(a)}return e}(),!u.length&&!r?i.resolve(s):o.save(e,t,s,r).then(i.resolve,i.reject)):i.resolve(s)}),s.fail(function(){return o.save(e,t,n,r).then(i.resolve,i.reject)}),i.promise()},e.prototype.updateAll=function(e,t,n){var r,i=this;n==null&&(n={});switch(!0){case typeof e=="string":r=this.findAll(e);break;case this.hoodie.isPromise(e):r=e;break;case $.isArray(e):r=this.hoodie.defer().resolve(e).promise();break;default:r=this.findAll()}return r.pipe(function(e){var r,s,o;return r=i.hoodie.defer(),$.isArray(e)||(e=[e]),o=function(){var r,i,o;o=[];for(r=0,i=e.length;r<i;r++)s=e[r],o.push(this.update(s.$type,s.id,t,n));return o}.call(i),$.when.apply(null,o).then(r.resolve),r.promise()})},e.prototype.find=function(e,t){var n;return n=this.hoodie.defer(),typeof e!="string"||typeof t!="string"?n.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():n},e.prototype.findOrAdd=function(e,t,n){var r,i=this;return n==null&&(n={}),r=this.hoodie.defer(),this.find(e,t).done(r.resolve).fail(function(){var s;return s=$.extend({id:t},n),i.add(e,s).then(r.resolve,r.reject)}),r.promise()},e.prototype.findAll=function(){return this.hoodie.defer()},e.prototype.remove=function(e,t,n){var r;return n==null&&(n={}),r=this.hoodie.defer(),typeof e!="string"||typeof t!="string"?r.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():r},e.prototype.removeAll=function(e,t){var n=this;return t==null&&(t={}),this.findAll(e).pipe(function(e){var r,i,s,o;o=[];for(i=0,s=e.length;i<s;i++)r=e[i],o.push(n.remove(r.$type,r.id,t));return o})},e.prototype._now=function(){return new Date},e.prototype._isValidId=function(e){return/^[a-z0-9\-]+$/.test(e)},e.prototype._isValidType=function(e){return/^[a-z$][a-z0-9]+$/.test(e)},e}(),Hoodie.User=function(){function e(e){var t=this;return this.hoodie=e,this.hoodie.store.decoratePromises({publish:this._storePublish,unpublish:this._storeUnpublish}),function(e,n){return n==null&&(n={}),$.extend(n,{prefix:"$public"}),t.hoodie.open("user/"+e+"/public",n)}}return e.prototype._storePublish=function(e){var t=this;return this.pipe(function(n){var r,i,s,o;$.isArray(n)||(n=[n]),o=[];for(i=0,s=n.length;i<s;i++)r=n[i],o.push(t.hoodie.store.update(r.$type,r.id,{$public:e||!0}));return o})},e.prototype._storeUnpublish=function(){var e=this;return this.pipe(function(t){var n,r,i,s;$.isArray(t)||(t=[t]),s=[];for(r=0,i=t.length;r<i;r++)n=t[r],n.$public&&s.push(e.hoodie.store.update(n.$type,n.id,{$public:!1}));return s})},e}(),Hoodie.extend("user",Hoodie.User),Hoodie.Global=function(){function e(e){return e.open("global")}return e}(),Hoodie.extend("global",Hoodie.Global),Hoodie.AccountRemote=function(e){function t(e,n){this.hoodie=e,n==null&&(n={}),this._handlePullResults=__bind(this._handlePullResults,this),this._handlePushSuccess=__bind(this._handlePushSuccess,this),this._handleSignIn=__bind(this._handleSignIn,this),this.push=__bind(this.push,this),this.sync=__bind(this.sync,this),this.stopSyncing=__bind(this.stopSyncing,this),this.startSyncing=__bind(this.startSyncing,this),this.connect=__bind(this.connect,this),this.name=this.hoodie.account.db(),this.hoodie.config.get("_remote.sync")!=null&&(this._sync=this.hoodie.config.get("_remote.sync")),n.prefix="",t.__super__.constructor.call(this,this.hoodie,n)}return __extends(t,e),t.prototype._sync=!0,t.prototype.connect=function(){var e=this;return this.hoodie.account.authenticate().pipe(function(){return t.__super__.connect.apply(e,arguments)})},t.prototype.disconnect=function(){return this.hoodie.unbind("store:idle",this.push),t.__super__.disconnect.apply(this,arguments)},t.prototype.startSyncing=function(){return this.hoodie.config.set("_remote.sync",!0),this.hoodie.on("account:signin",this._handleSignIn),this.hoodie.on("account:signout",this.disconnect),t.__super__.startSyncing.apply(this,arguments)},t.prototype.stopSyncing=function(){return this.hoodie.config.set("_remote.sync",!1),this.hoodie.unbind("account:signin",this._handleSignIn),this.hoodie.unbind("account:signout",this.disconnect),t.__super__.stopSyncing.apply(this,arguments)},t.prototype.sync=function(e){return this.isContinuouslyPushing()&&(this.hoodie.unbind("store:idle",this.push),this.hoodie.on("store:idle",this.push)),t.__super__.sync.apply(this,arguments)},t.prototype.getSinceNr=function(e){return this.hoodie.config.get("_remote.since")||0},t.prototype.setSinceNr=function(e){return this.hoodie.config.set("_remote.since",e)},t.prototype.push=function(e){var n;return $.isArray(e)||(e=this.hoodie.store.changedDocs()),n=t.__super__.push.call(this,e)},t.prototype.on=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.on(e,t)},t.prototype.one=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.one(e,t)},t.prototype.trigger=function(){var e,t,n;return e=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],(n=this.hoodie).trigger.apply(n,["remote:"+e].concat(__slice.call(t)))},t.prototype._handleSignIn=function(){return this.name=this.hoodie.account.db(),this.connect()},t.prototype._handlePushSuccess=function(e,t){var n=this;return function(){var r,i,s,o,u,a,f;f=[];for(i=u=0,a=e.length;u<a;i=++u)r=e[i],o={_rev:t[i]._rev},s={remote:!0},f.push(n.hoodie.store.update(r.$type,r.id,o,s));return f}},t.prototype._handlePullResults=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d=this;h=[],r=[];for(i=0,u=e.length;i<u;i++)t=e[i].doc,t=this.store.parseFromRemote(t),t._deleted?h.push([t,this.hoodie.store.remove(t.$type,t.id,{remote:!0})]):r.push([t,this.hoodie.store.save(t.$type,t.id,t,{remote:!0})]);for(s=0,a=h.length;s<a;s++)l=h[s],t=l[0],n=l[1],n.then(function(e){return d.trigger("remove",e),d.trigger("remove:"+t.$type,e),d.trigger("remove:"+t.$type+":"+t.id,e),d.trigger("change","remove",e),d.trigger("change:"+t.$type,"remove",e),d.trigger("change:"+t.$type+":"+t.id,"remove",e)});p=[];for(o=0,f=r.length;o<f;o++)c=r[o],t=c[0],n=c[1],p.push(n.then(function(e,n){var r;r=n?"create":"update",d.trigger(r,e),d.trigger(""+r+":"+t.$type,e),r!=="create"&&d.trigger(""+r+":"+t.$type+":"+t.id,e),d.trigger("change",r,e),d.trigger("change:"+t.$type,r,e);if(r!=="create")return d.trigger("change:"+t.$type+":"+t.id,r,e)}));return p},t}(Hoodie.Remote),Hoodie.LocalStore=function(e){function t(e){this.hoodie=e,this.clear=__bind(this.clear,this),this.markAllAsChanged=__bind(this.markAllAsChanged,this),this.isPersistent()||(this.db={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:0,clear:function(){return null}}),this.hoodie.on("account:signout",this.clear),this.hoodie.on("account:signup",this.markAllAsChanged),this._promiseApi.hoodie=this.hoodie,this._bootstrap()}return __extends(t,e),t.prototype.idleTimeout=2e3,t.prototype.db={getItem:function(e){return window.localStorage.getItem(e)},setItem:function(e,t){return window.localStorage.setItem(e,t)},removeItem:function(e){return window.localStorage.removeItem(e)},key:function(e){return window.localStorage.key(e)},length:function(){return window.localStorage.length},clear:function(){return window.localStorage.clear()}},t.prototype.save=function(e,n,r,i){var s,o,u,a,f;i==null&&(i={}),o=t.__super__.save.apply(this,arguments);if(this.hoodie.isPromise(o))return this._decoratePromise(o);r=$.extend(!0,{},r),n?(s=this.cache(e,n),a=typeof s!="object"):(a=!0,n=this.hoodie.uuid()),a&&this.hoodie.account&&(r.$createdBy||(r.$createdBy=this.hoodie.account.ownerHash));if(!a){delete r.$updatedBy;for(f in s)if(!r.hasOwnProperty(f))switch(f.charAt(0)){case"_":i.remote&&(r[f]=s[f]);break;case"$":i.remote||(r[f]=s[f])}}i.remote?r._$syncedAt=this._now():i.silent||(r.$updatedAt=this._now(),r.$createdAt||(r.$createdAt=r.$updatedAt));try{r=this.cache(e,n,r,i),o.resolve(r,a).promise(),u=a?"add":"update",this._triggerEvents(u,r,i)}catch(l){o.reject(l).promise()}return this._decoratePromise(o.promise())},t.prototype.find=function(e,n){var r,i;r=t.__super__.find.apply(this,arguments);if(this.hoodie.isPromise
(r))return this._decoratePromise(r);try{i=this.cache(e,n),i||r.reject(Hoodie.Errors.NOT_FOUND(e,n)).promise(),r.resolve(i)}catch(s){r.reject(s)}return this._decoratePromise(r.promise())},t.prototype.findAll=function(e){var n,r,i,s,o,u,a,f;e==null&&(e=function(){return!0}),r=t.__super__.findAll.apply(this,arguments);if(this.hoodie.isPromise(r))return this._decoratePromise(r);o=this._index(),typeof e=="string"&&(f=e,e=function(e){return e.$type===f});try{a=function(){var t,r,a,f;f=[];for(t=0,r=o.length;t<r;t++){s=o[t];if(!this._isSemanticId(s))continue;a=s.split("/"),n=a[0],i=a[1],u=this.cache(n,i);if(!u||!e(u))continue;f.push(u)}return f}.call(this),r.resolve(a).promise()}catch(l){r.reject(l).promise()}return this._decoratePromise(r.promise())},t.prototype.remove=function(e,n,r){var i,s,o,u;return r==null&&(r={}),i=t.__super__.remove.apply(this,arguments),this.hoodie.isPromise(i)?this._decoratePromise(i):(o=this.cache(e,n),o?(o._$syncedAt&&!r.remote?(o._deleted=!0,this.cache(e,n,o)):(s=""+e+"/"+n,this.db.removeItem(s),this._cached[s]=!1,this.clearChanged(e,n)),this._triggerEvents("remove",o,r),u=i.resolve($.extend(!0,{},o)).promise(),this._decoratePromise(u)):this._decoratePromise(i.reject(Hoodie.Errors.NOT_FOUND(e,n)).promise()))},t.prototype.update=function(){return this._decoratePromise(t.__super__.update.apply(this,arguments))},t.prototype.updateAll=function(){return this._decoratePromise(t.__super__.updateAll.apply(this,arguments))},t.prototype.removeAll=function(){return this._decoratePromise(t.__super__.removeAll.apply(this,arguments))},t.prototype.cache=function(e,t,n,r){var i;n==null&&(n=!1),r==null&&(r={}),i=""+e+"/"+t;if(n){$.extend(!0,n,{$type:e,id:t}),this._setObject(e,t,n);if(r.remote)return this.clearChanged(e,t),this._cached[i]=n,$.extend(!0,{},this._cached[i])}else{if(this._cached[i]===!1)return!1;if(this._cached[i])return $.extend(!0,{},this._cached[i]);n=this._getObject(e,t)}if(n===void 0)return;return n===!1?(this.clearChanged(e,t),this._cached[i]=!1,!1):this._isMarkedAsDeleted(n)?(this.markAsChanged(e,t,n,r),this._cached[i]=!1,!1):(this._cached[i]=n,this._isDirty(n)?this.markAsChanged(e,t,n,r):this.clearChanged(e,t),$.extend(!0,{},this._cached[i]))},t.prototype.clearChanged=function(e,t){var n;return e&&t?(n=""+e+"/"+t,delete this._dirty[n]):this._dirty={},this._saveDirtyIds(),window.clearTimeout(this._dirtyTimeout)},t.prototype.isMarkedAsDeleted=function(e,t){return this._isMarkedAsDeleted(this.cache(e,t))},t.prototype.markAsChanged=function(e,t,n,r){var i;r==null&&(r={}),i=""+e+"/"+t,this._dirty[i]=n,this._saveDirtyIds();if(r.silent)return;return this._trigger_dirty_and_idle_events()},t.prototype.markAllAsChanged=function(){var e=this;return this.findAll().pipe(function(t){var n,r,i,s;for(i=0,s=t.length;i<s;i++)r=t[i],n=""+r.$type+"/"+r.id,e._dirty[n]=r;return e._saveDirtyIds(),e._trigger_dirty_and_idle_events()})},t.prototype.changedDocs=function(){var e,t,n,r,i,s,o;i=this._dirty,o=[];for(t in i)n=i[t],s=t.split("/"),r=s[0],e=s[1],n.$type=r,n.id=e,o.push(n);return o},t.prototype.isDirty=function(e,t){return e?this._isDirty(this.cache(e,t)):$.isEmptyObject(this._dirty)},t.prototype.clear=function(){var e,t,n,r;e=this.hoodie.defer();try{n=this._index(),r=function(){var e,r,i;i=[];for(e=0,r=n.length;e<r;e++)t=n[e],this._isSemanticId(t)&&i.push(this.db.removeItem(t));return i}.call(this),this._cached={},this.clearChanged(),e.resolve(),this.trigger("clear")}catch(i){e.reject(i)}return e.promise()},t.prototype.isPersistent=function(){try{if(!window.localStorage)return!1;localStorage.setItem("Storage-Test","1");if(localStorage.getItem("Storage-Test")!=="1")return!1;localStorage.removeItem("Storage-Test")}catch(e){return!1}return!0},t.prototype.trigger=function(){var e,t,n;return e=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],(n=this.hoodie).trigger.apply(n,["store:"+e].concat(__slice.call(t)))},t.prototype.on=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1store:$2"),this.hoodie.on(e,t)},t.prototype.decoratePromises=function(e){return $.extend(this._promiseApi,e)},t.prototype._bootstrap=function(){var e,t,n,r,i,s,o,u,a;n=this.db.getItem("_dirty");if(!n)return;a=[];for(s=0,o=n.length;s<o;s++)t=n[s],u=t.split("/"),i=u[0],e=u[1],a.push(r=this.cache(i,e));return a},t.prototype._setObject=function(e,t,n){var r,i;return r=""+e+"/"+t,i=$.extend({},n),delete i.$type,delete i.id,this.db.setItem(r,JSON.stringify(i))},t.prototype._getObject=function(e,t){var n,r,i;return r=""+e+"/"+t,n=this.db.getItem(r),n?(i=JSON.parse(n),i.$type=e,i.id=t,i.$createdAt&&(i.$createdAt=new Date(Date.parse(i.$createdAt))),i.$updatedAt&&(i.$updatedAt=new Date(Date.parse(i.$updatedAt))),i._$syncedAt&&(i._$syncedAt=new Date(Date.parse(i._$syncedAt))),i):!1},t.prototype._saveDirtyIds=function(){var e;return $.isEmptyObject(this._dirty)?this.db.removeItem("_dirty"):(e=Object.keys(this._dirty),this.db.setItem("_dirty",e.join(",")))},t.prototype._now=function(){return new Date},t.prototype._isValidId=function(e){return/^[a-z0-9\-]+$/.test(e)},t.prototype._isValidType=function(e){return/^[a-z$][a-z0-9]+$/.test(e)},t.prototype._isSemanticId=function(e){return/^[a-z$][a-z0-9]+\/[a-z0-9]+$/.test(e)},t.prototype._cached={},t.prototype._dirty={},t.prototype._isDirty=function(e){return e.$updatedAt?e._$syncedAt?e._$syncedAt.getTime()<e.$updatedAt.getTime():!0:!1},t.prototype._isMarkedAsDeleted=function(e){return e._deleted===!0},t.prototype._index=function(){var e,t,n,r;r=[];for(e=t=0,n=this.db.length();0<=n?t<n:t>n;e=0<=n?++t:--t)r.push(this.db.key(e));return r},t.prototype._triggerEvents=function(e,t,n){this.trigger(e,t,n),this.trigger(""+e+":"+t.$type,t,n),e!=="new"&&this.trigger(""+e+":"+t.$type+":"+t.id,t,n),this.trigger("change",e,t,n),this.trigger("change:"+t.$type,e,t,n);if(e!=="new")return this.trigger("change:"+t.$type+":"+t.id,e,t,n)},t.prototype._trigger_dirty_and_idle_events=function(){var e=this;return this.trigger("dirty"),window.clearTimeout(this._dirtyTimeout),this._dirtyTimeout=window.setTimeout(function(){return e.trigger("idle")},this.idleTimeout)},t.prototype._promiseApi={},t.prototype._decoratePromise=function(e){return $.extend(e,this._promiseApi)},t}(Hoodie.Store),Hoodie.RemoteStore=function(e){function t(e,t){this.hoodie=e,this.remote=t,this._mapDocsFromFindAll=__bind(this._mapDocsFromFindAll,this),this.parseAllFromRemote=__bind(this.parseAllFromRemote,this),this.parseFromRemote=__bind(this.parseFromRemote,this)}return __extends(t,e),t.prototype.find=function(e,n){var r,i;return r=t.__super__.find.apply(this,arguments),this.hoodie.isPromise(r)?r:(i="/"+encodeURIComponent(""+e+"/"+n),this.remote.request("GET",i).pipe(this.parseFromRemote))},t.prototype.findAll=function(e){var n,r,i,s;n=t.__super__.findAll.apply(this,arguments);if(this.hoodie.isPromise(n))return n;i="/_all_docs?include_docs=true";switch(!0){case e!=null&&this.remote.prefix!=="":r=""+this.remote.prefix+"/"+e;break;case e!=null:r=e;break;case this.remote.prefix!=="":r=this.remote.prefix;break;default:r=""}return r&&(i=""+i+'&startkey="'+r+'/"&endkey="'+r+'0"'),s=this.remote.request("GET",i),s.fail(n.reject),s.pipe(this._mapDocsFromFindAll).pipe(this.parseAllFromRemote).done(n.resolve),n.promise()},t.prototype.save=function(e,n,r){var i,s,o;return i=t.__super__.save.apply(this,arguments),this.hoodie.isPromise(i)?i:(n||(n=this.hoodie.uuid()),r=$.extend({$type:e,id:n},r),s=this.parseForRemote(r),o="/"+encodeURIComponent(s._id),this.remote.request("PUT",o,{data:s}))},t.prototype.remove=function(e,t){return this.update(e,t,{_deleted:!0})},t.prototype.removeAll=function(e){return this.updateAll(e,{_deleted:!0})},t.prototype.parseForRemote=function(e){var t,n;n=$.extend({},e);for(t in n){if(~this._validSpecialAttributes.indexOf(t))continue;if(!/^_/.test(t))continue;delete n[t]}return n._id=""+n.$type+"/"+n.id,this.remote.prefix&&(n._id=""+this.remote.prefix+"/"+n._id),delete n.id,this._addRevisionTo(n),n},t.prototype.parseFromRemote=function(e){var t,n;return t=e._id||e.id,delete e._id,this.remote.prefix&&(t=t.replace(RegExp("^"+this.remote.prefix+"/"),"")),n=t.split(/\//),e.$type=n[0],e.id=n[1],e.$createdAt&&(e.$createdAt=new Date(Date.parse(e.$createdAt))),e.$updatedAt&&(e.$updatedAt=new Date(Date.parse(e.$updatedAt))),e.rev&&(e._rev=e.rev,delete e.rev),e},t.prototype.parseAllFromRemote=function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.parseFromRemote(t));return i},t.prototype.on=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1"+this.remote.name+":store:$2"),this.hoodie.on(e,t)},t.prototype.one=function(e,t){return e=e.replace(/(^| )([^ ]+)/g,"$1"+this.remote.name+":store:$2"),this.hoodie.one(e,t)},t.prototype.trigger=function(){var e,t,n;return e=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],(n=this.hoodie).trigger.apply(n,[""+this.remote.name+":store:"+e].concat(__slice.call(t)))},t.prototype._validSpecialAttributes=["_id","_rev","_deleted","_revisions","_attachments"],t.prototype._generateNewRevisionId=function(){return this.hoodie.uuid(9)},t.prototype._addRevisionTo=function(e){var t,n,r,i;try{i=e._rev.split(/-/),n=i[0],t=i[1]}catch(s){}n=parseInt(n,10)||0,r=this._generateNewRevisionId(),e._rev=""+(n+1)+"-"+r,e._revisions={start:1,ids:[r]};if(t)return e._revisions.start+=n,e._revisions.ids.push(t)},t.prototype._mapDocsFromFindAll=function(e){return e.rows.map(function(e){return e.doc})},t}(Hoodie.Store),Hoodie.ShareInstance=function(e){function t(e,n){this.hoodie=e,n==null&&(n={}),this._handleSecurityResponse=__bind(this._handleSecurityResponse,this),this.id=n.id||this.hoodie.uuid(),this.name="share/"+this.id,this.prefix=this.name,n.sync!=null&&(n._sync=n.sync,delete n.sync),$.extend(this,n),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.access=!1,t.prototype.subscribe=function(){return this.request("GET","/_security").pipe(this._handleSecurityResponse)},t.prototype.unsubscribe=function(){return this.hoodie.share.remove(this.id),this},t.prototype.grantReadAccess=function(e){var t,n,r,i;if(this.access===!0||this.access.read===!0)return this.hoodie.resolveWith(this);typeof e=="string"&&(e=[e]);if(this.access===!1||this.access.read===!1)this.access.read!=null?this.access.read=e||!0:this.access=e||!0;if(e){t=this.access.read||this.access;for(r=0,i=e.length;r<i;r++)n=e[r],t.indexOf(n)===-1&&t.push(n);this.access.read!=null?this.access.read=t:this.access=t}else this.access.read!=null?this.access.read=!0:this.access=!0;return this.hoodie.share.update(this.id,{access:this.access})},t.prototype.revokeReadAccess=function(e){var t,n,r,i,s,o;this.revokeWriteAccess(e);if(this.access===!1||this.access.read===!1)return this.hoodie.resolveWith(this);if(e){if(this.access===!0||this.access.read===!0)return this.hoodie.rejectWith(this);typeof e=="string"&&(e=[e]),n=this.access.read||this.access,t=!1;for(s=0,o=e.length;s<o;s++)i=e[s],r=n.indexOf(i),r!==-1&&(n.splice(r,1),t=!0);if(!t)return this.hoodie.resolveWith(this);n.length===0&&(n=!1),this.access.read!=null?this.access.read=n:this.access=n}else this.access=!1;return this.hoodie.share.update(this.id,{access:this.access})},t.prototype.grantWriteAccess=function(e){return this.grantReadAccess(e),this.access.read==null&&(this.access={read:this.access}),this.access.write===!0?this.hoodie.resolveWith(this):(e?(typeof e=="string"&&(e=[e]),this.access.write=e):this.access.write=!0,this.hoodie.share.update(this.id,{access:this.access}))},t.prototype.revokeWriteAccess=function(e){var t,n,r,i;if(this.access.write==null)return this.hoodie.resolveWith(this);if(e){if(typeof this.access.write=="boolean")return this.hoodie.rejectWith(this);typeof e=="string"&&(e=[e]);for(r=0,i=e.length;r<i;r++)n=e[r],t=this.access.write.indexOf(n),t!==-1&&this.access.write.splice(t,1);this.access.write.length===0&&(this.access=this.access.read)}else this.access=this.access.read;return this.hoodie.share.update(this.id,{access:this.access})},t.prototype._handleSecurityResponse=function(e){var t,n;return n=this._parseSecurity(e),t="$subscription",this.hoodie.share.findOrAdd(this.id,{access:n,$createdBy:t})},t.prototype._parseSecurity=function(e){var t,n,r,i,s;return n=(i=e.members)!=null?i.roles:void 0,r=(s=e.writers)!=null?s.roles:void 0,t={},n!=null&&(t.read=n===!0||n.length===0,n.length&&(t.read=-1!==n.indexOf(this.hoodie.account.ownerHash))),r!=null&&(t.write=r===!0||r.length===0,r.length&&(t.write=-1!==r.indexOf(this.hoodie.account.ownerHash))),t},t}(Hoodie.Remote);